version: "3.9"
services:
  siai-server:
    image: fabreguesm/siai_server:1.0.1
    ports:
      - "6210:6210"
    environment:
      # Database
      DB_HOST: ${DB_HOST}
      DB_PORT: ${DB_PORT}
      DB_PATH: ${DB_PATH}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      # Server
      PORT: ${SERVER_PORT}
      FRONTEND_URL: ${FRONTEND_URL}
      SECRET_KEY: ${SECRET_KEY}
      PUBLIC_KEY: ${PUBLIC_KEY}
      # Logging
      LOG_FILE: ${LOG_FILE}
      LOG_FORMAT: ${LOG_FORMAT}
      LOG_SIZE: ${LOG_SIZE}
      LOG_INTERVAL: ${LOG_INTERVAL}
    volumes:
      - server-uploads:/app/uploads
      - server-logs:/app/logs
    networks:
      - siai-network
    healthcheck:
      test: ["CMD-SHELL", "wget --spider -q http://10.250.0.68:6210 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      replicas: 1
      restart_policy:
        condition: any

  siai-client:
    image: fabreguesm/siai_cliente:1.0.1
    ports:
      - "6212:80"
    environment:
      VITE_BACKEND_URL: ${VITE_BACKEND_URL}
      VITE_APP_PORT: ${VITE_APP_PORT}
    networks:
      - siai-network
    # En Swarm no funciona depends_on. Si necesitÃ¡s que espere al server:
    command: >
      sh -c 'until wget -q -O- http://10.250.0.68:6210/ || sleep 2; do :; done;
             nginx -g "daemon off;"'
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://10.250.0.68:80 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      replicas: 1
      restart_policy:
        condition: any

networks:
  siai-network:
    driver: overlay

volumes:
  server-uploads:
  server-logs:

version: "3.8"
services:
  siai-server:
    build:
      context: ./server
      dockerfile: Dockerfile
    container_name: siai-server
    restart: unless-stopped
    ports:
      - "6210:6210"
    environment:
      # Database
      DB_HOST: ${DB_HOST}
      DB_PORT: ${DB_PORT}
      DB_PATH: ${DB_PATH}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      # Server
      PORT: ${SERVER_PORT}
      FRONTEND_URL: ${FRONTEND_URL}
      SECRET_KEY: ${SECRET_KEY}
      PUBLIC_KEY: ${PUBLIC_KEY}
      # Logging
      LOG_FILE: ${LOG_FILE}
      LOG_FORMAT: ${LOG_FORMAT}
      LOG_SIZE: ${LOG_SIZE}
      LOG_INTERVAL: ${LOG_INTERVAL}
    volumes:
      - ./server/uploads:/app/uploads
      - ./server/logs:/app/logs
    networks:
      - siai-network
    healthcheck:
      test: ["CMD-SHELL", "node -e \"require('http').get('http://10.254.252.91:6210/', r=>process.exit(r.statusCode===200?0:1)).on('error',()=>process.exit(1))\""]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  siai-client:
    build:
      context: ./cliente
      dockerfile: Dockerfile
    container_name: siai-client
    restart: unless-stopped
    ports:
      - "6212:80"
    environment:
      VITE_BACKEND_URL: ${VITE_BACKEND_URL}
      VITE_APP_PORT: ${VITE_APP_PORT}
    depends_on:
      - siai-server
    networks:
      - siai-network
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://127.0.0.1:80 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

networks:
  siai-network:
    driver: bridge
    name: siai-network
